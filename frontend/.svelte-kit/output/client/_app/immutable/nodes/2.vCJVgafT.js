import{r as q,s as F,n as P}from"../chunks/scheduler.zMJaRgub.js";import{t as G,S as J,i as K,e as E,s as $,c as N,d as T,m as W,h as C,g as A,n as j,j as U,k as y,o as V,p as r}from"../chunks/index.LfI3cGzv.js";function D(o){return(o==null?void 0:o.length)!==void 0?o:Array.from(o)}function Q(o,e){o.d(1),e.delete(o.key)}function R(o,e,n,t,m,d,f,i,l,s,k,M){let _=o.length,g=d.length,p=_;const a={};for(;p--;)a[o[p].key]=p;const c=[],u=new Map,b=new Map,z=[];for(p=g;p--;){const h=M(m,d,p),v=n(h);let w=f.get(v);w?t&&z.push(()=>w.p(h,e)):(w=s(v,h),w.c()),u.set(v,c[p]=w),v in a&&b.set(v,Math.abs(p-a[v]))}const I=new Set,O=new Set;function L(h){G(h,1),h.m(i,k),f.set(h.key,h),k=h.first,g--}for(;_&&g;){const h=c[g-1],v=o[_-1],w=h.key,S=v.key;h===v?(k=h.first,_--,g--):u.has(S)?!f.has(w)||I.has(w)?L(h):O.has(S)?_--:b.get(w)>b.get(S)?(O.add(w),L(h)):(I.add(S),_--):(l(v,f),_--)}for(;_--;){const h=o[_];u.has(h.key)||l(h,f)}for(;g;)L(c[g-1]);return q(z),c}function H(o,e,n){const t=o.slice();t[4]=e[n];const m=t[0][t[4]];t[5]=m;const d=t[5]==="lost";t[6]=d;const f=t[5]==="leader";t[7]=f;const i=t[5]==="dead";t[8]=i;const l=t[5]==="follower";return t[9]=l,t}function B(o,e){let n,t,m,d,f;function i(){return e[2](e[4])}return{key:o,first:null,c(){n=E("div"),t=E("button"),m=$(),this.h()},l(l){n=N(l,"DIV",{class:!0});var s=T(n);t=N(s,"BUTTON",{class:!0}),T(t).forEach(A),m=C(s),s.forEach(A),this.h()},h(){j(t,"class","svelte-1lmhjiz"),r(t,"leader",e[7]),r(t,"lost",e[6]),r(t,"dead",e[8]),r(t,"follower",e[9]),j(n,"class","child svelte-1lmhjiz"),r(n,"leader",e[7]),r(n,"lost",e[6]),r(n,"dead",e[8]),r(n,"follower",e[9]),this.first=n},m(l,s){U(l,n,s),y(n,t),y(n,m),d||(f=V(t,"click",i),d=!0)},p(l,s){e=l,s&1&&r(t,"leader",e[7]),s&1&&r(t,"lost",e[6]),s&1&&r(t,"dead",e[8]),s&1&&r(t,"follower",e[9]),s&1&&r(n,"leader",e[7]),s&1&&r(n,"lost",e[6]),s&1&&r(n,"dead",e[8]),s&1&&r(n,"follower",e[9])},d(l){l&&A(n),d=!1,f()}}}function X(o){let e,n,t="Welcome to <s>the Thunderdome</s> Paxos",m,d,f="Add another node",i,l,s=[],k=new Map,M,_,g=D(Array.from(Array(o[0].length).keys()));const p=a=>a[4];for(let a=0;a<g.length;a+=1){let c=H(o,g,a),u=p(c);k.set(u,s[a]=B(u,c))}return{c(){e=E("main"),n=E("h2"),n.innerHTML=t,m=$(),d=E("button"),d.textContent=f,i=$(),l=E("div");for(let a=0;a<s.length;a+=1)s[a].c();this.h()},l(a){e=N(a,"MAIN",{});var c=T(e);n=N(c,"H2",{"data-svelte-h":!0}),W(n)!=="svelte-108l63t"&&(n.innerHTML=t),m=C(c),d=N(c,"BUTTON",{class:!0,"data-svelte-h":!0}),W(d)!=="svelte-1eoibcv"&&(d.textContent=f),i=C(c),l=N(c,"DIV",{class:!0});var u=T(l);for(let b=0;b<s.length;b+=1)s[b].l(u);u.forEach(A),c.forEach(A),this.h()},h(){j(d,"class","svelte-1lmhjiz"),j(l,"class","row svelte-1lmhjiz")},m(a,c){U(a,e,c),y(e,n),y(e,m),y(e,d),y(e,i),y(e,l);for(let u=0;u<s.length;u+=1)s[u]&&s[u].m(l,null);M||(_=V(d,"click",o[1]),M=!0)},p(a,[c]){c&1&&(g=D(Array.from(Array(a[0].length).keys())),s=R(s,c,p,1,a,g,k,l,Q,B,null,H))},i:P,o:P,d(a){a&&A(e);for(let c=0;c<s.length;c+=1)s[c].d();M=!1,_()}}}function Y(o){setInterval(()=>{o.readyState===WebSocket.OPEN&&o.send("status")},250)}function Z(o,e,n){let t=[];const m=(i,l)=>[...i,l];return[t,async()=>{fetch("http://localhost:3000/new_node").then(s=>s.json()).then(s=>{console.log(s),n(0,t=m(t,{...s,status:"dead"}))}).catch(s=>console.log(s));const i=t[t.length-1],l=new WebSocket(`ws://localhost:${i.nodeWs}`);l.addEventListener("open",()=>{console.log(`${i.name} opened connection`)}),l.addEventListener("close",()=>{i.status="dead"}),l.addEventListener("error",s=>{i.status="dead"}),l.onmessage=s=>{switch(s.data){case"pong":break;case"dead":{i.status="dead";break}case"iLead":{i.status="leader";break}case"found":{i.status="follower";break}default:{i.status="lost";break}}Y(l),l.onerror=k=>{console.log(k)}}},i=>knockOut(i)]}class te extends J{constructor(e){super(),K(this,e,Z,X,F,{})}}export{te as component};
